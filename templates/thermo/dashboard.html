{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link rel="stylesheet" type="text/css" href="{% static "/css/base.css" %}">
    <link href="https://fonts.googleapis.com/css?family=Roboto|Roboto+Mono" rel="stylesheet">

</head>
<body>
    <div class="container">
        <div class="item datetime">
            <div class="description sun">
               {% now "d-m-Y" %}
            </div>
            <div class="description hour sun">
                {% now "H:i" %}
            </div>
        </div>

        <div class="item temperature">
            <div class="description">
                Temperatura:
            </div>
            <div class="value">
                {{ temperature }}°C
            </div>
        </div>

        <div class="item humidity">
            <div class="description">
                Wilgotność:
            </div>
            <div class="value">
                {{ humidity }} %
            </div>
        </div>

        <div class="item sunrise">
            <div class="description">
                Wschód słońca:
            </div>
            <div class="description hour sun">
                {{ sunrise }}
            </div>

        </div>

        <div class="item sunset">
            <div class="description">
                Zachód słońca:
            </div>
            <div class="description hour sun">
                {{ sunset }}
            </div>
        </div>
        <div class="item chart">
            <svg id="chart"></svg>
        </div>
    </div>

    <script src="{% static "/js/d3.v5.min.js" %}"></script>
    <script>
        function parseData(data) {
            var datetimeFormat = d3.isoFormat;

            var arr = [];
            for (var i in data) {
                arr.push(
                    {
                        date: d3.isoParse(data[i][0]),
                        value: data[i][1]
                    }
                );
            }
            return arr;
        }

        var data = parseData({{ records.temperature|safe }});
        var data1 = parseData({{ records.humidity|safe }});

        // var svgWidth = 480, svgHeight = 480;
        var svgWidth = parseInt(d3.select("#chart").style("width")),
            svgHeight = parseInt(d3.select("#chart").style("height"));

        var margin = { top: 0, right: 20, bottom: 30, left: 30 },
            width = svgWidth - margin.left - margin.right,
            height = svgHeight - margin.top - margin.bottom;

        var svg = d3.select('svg')
            .attr("width", svgWidth)
            .attr("height", svgHeight)
            //.attr("preserveAspectRatio", "xMinYMin meet")
            //.attr("viewBox", "0 0 " + svgWidth + " " + svgHeight);

        var g = svg.append("g")
        .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")"
        );

        var x = d3.scaleTime().rangeRound([0, width]);
        var y = d3.scaleLinear().rangeRound([height, 0]);
        var y1 = d3.scaleLinear().rangeRound([height, 0]);


        var line = d3.line()
            .x(function(d) { return x(d.date)})
            .y(function(d) { return y(d.value)})
            //.curve(d3.curveCardinal)
            ;

        var line1 = d3.line()
            .x(function(d) { return x(d.date)})
            .y(function(d) { return y1(d.value)})
            //.curve(d3.curveCardinal)
            ;

        x.domain(d3.extent(data, function(d) { console.log(d.date); return d.date }));
        y.domain(d3.extent(data, function(d) { return d.value }));
        y1.domain(d3.extent(data1, function(d) { return d.value }));


        g.append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x))
            .select(".domain")
            .remove();

        g.append("g")
            .call(d3.axisLeft(y))
            .append("text")
            .attr("fill", "steelblue")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", "0.71em")
            .attr("text-anchor", "end")
            .text("Temperatura (°C)");

        g.append("g")
            .attr("transform", "translate( " + width + ", 0 )")
            .call(d3.axisRight(y1))
            .append("text")
            .attr("fill", "seagreen")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", "-1em")
            .attr("text-anchor", "end")
            .text("Wilgotność (%)");

        g.append("path")
            .datum(data)
            .attr("fill", "none")
            .attr("stroke", "steelblue")
            .attr("stroke-linejoin", "round")
            .attr("stroke-linecap", "round")
            .attr("stroke-width", 2)
            .attr("d", line);

        g.append("path")
            .datum(data1)
            .attr("fill", "none")
            .attr("stroke", "seagreen")
            .attr("stroke-linejoin", "round")
            .attr("stroke-linecap", "round")
            .attr("stroke-width", 2)
            .attr("d", line1);
    </script>
</body>
</html>